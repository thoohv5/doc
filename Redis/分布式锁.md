# 分布式锁-Redis

# 基础知识

## set

Set `key` to hold the string `value`. If `key` already holds a value, it is overwritten, regardless of its type. Any previous time to live associated with the key is discarded on successful `SET` operation.

将键`key`设定为指定的“字符串”值。

如果 key 已经保存了一个值，那么这个操作会直接覆盖原来的值，并且忽略原始类型。

当`set`命令执行成功之后，之前设置的过期时间都将失效

### #**选项** `2.6.12版本`

- `EX` *seconds* – Set the specified expire time, in seconds.
- `PX` *milliseconds* – Set the specified expire time, in milliseconds.
- `NX` – Only set the key if it does not already exist.
- `XX` – Only set the key if it already exist.
- `EX` *seconds* – 设置键key的过期时间，单位时秒
- `PX` *milliseconds* – 设置键key的过期时间，单位时毫秒
- `NX` – 只有键key不存在的时候才会设置key的值
- `XX` – 只有键key存在的时候才会设置key的值

### 返回值

如果SET命令正常执行那么回返回OK，否则如果加了NX 或者 XX选项，但是没有设置条件。那么会返回nil。

# Redis分布式锁

## 单实例实现

### 获取锁命令

```bash
SET resource_name my_random_value NX PX expire-time
```

- 自动失效时间PX expire-time，防止死锁
- 开启独立的线程，增加失效时间，防止执行超时

### 释放锁的命令

```go
if redis.call("get",KEYS[1]) == ARGV[1] then
    return redis.call("del",KEYS[1])
else
    return 0
end
```

- 相同resource_name的获取者（竞争者），my_random_value唯一，安全释放锁，先检查随机值my_random_value，然后再删除，使用Lua脚本

### 安全释放锁的场景

a客户端获得的锁（键key）已经由于过期时间到了被redis服务器删除，但是这个时候a客户端还去执行DEL命令。而b客户端已经在a设置的过期时间之后重新获取了这个同样key的锁，那么a执行DEL就会释放了b客户端加好的锁。

### 死锁的场景

如果客户端出现故障，崩溃或者其他情况无法释放该锁会发生什么情况？锁会自动释放

## 集群实现

the Redlock algorithm

在Redis的分布式环境中，我们假设有N个Redis master。这些节点完全互相独立，不存在主从复制或者其他集群协调机制。

为了取到锁，客户端应该执行以下操作:

1. 获取当前Unix时间，以毫秒为单位。
2. 依次尝试从N个实例，使用相同的key和随机值获取锁。在步骤2，当向Redis设置锁时,客户端应该设置一个网络连接和响应超时时间，这个超时时间应该小于锁的失效时间。例如你的锁自动失效时间为10秒，则超时时间应该在5-50毫秒之间。这样可以避免服务器端Redis已经挂掉的情况下，客户端还在死死地等待响应结果。如果服务器端没有在规定时间内响应，客户端应该尽快尝试另外一个Redis实例。
3. 客户端使用当前时间减去开始获取锁时间（步骤1记录的时间）就得到获取锁使用的时间。当且仅当从大多数（这里是3个节点）的Redis节点都取到锁，并且使用的时间小于锁失效时间时，锁才算获取成功。
4. 如果取到了锁，key的真正有效时间等于有效时间减去获取锁所使用的时间（步骤3计算的结果）。
5. 如果因为某些原因，获取锁失败（*没有*在至少N/2+1个Redis实例取到锁或者取锁时间已经超过了有效时间），客户端应该在所有的Redis实例上进行解锁（即便某些Redis实例根本就没有加锁成功）。

# 附录

[REDIS distlock -- Redis中国用户组（CRUG）](http://redis.cn/topics/distlock.html)

[go-redsync/redsync](https://github.com/go-redsync/redsync)